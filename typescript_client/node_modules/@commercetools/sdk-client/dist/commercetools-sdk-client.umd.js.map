{"version":3,"file":"commercetools-sdk-client.umd.js","sources":["../src/allowed-methods.js","../src/validate.js","../src/client.js","../src/index.js"],"sourcesContent":["export default [\n  'ACL',\n  'BIND',\n  'CHECKOUT',\n  'CONNECT',\n  'COPY',\n  'DELETE',\n  'GET',\n  'HEAD',\n  'LINK',\n  'LOCK',\n  'M-SEARCH',\n  'MERGE',\n  'MKACTIVITY',\n  'MKCALENDAR',\n  'MKCOL',\n  'MOVE',\n  'NOTIFY',\n  'OPTIONS',\n  'PATCH',\n  'POST',\n  'PROPFIND',\n  'PROPPATCH',\n  'PURGE',\n  'PUT',\n  'REBIND',\n  'REPORT',\n  'SEARCH',\n  'SOURCE',\n  'SUBSCRIBE',\n  'TRACE',\n  'UNBIND',\n  'UNLINK',\n  'UNLOCK',\n  'UNSUBSCRIBE',\n]\n","import METHODS from './allowed-methods'\n\nexport default function validate(\n  funcName: string,\n  request: Object,\n  options: Object = { allowedMethods: METHODS }\n) {\n  if (!request)\n    // eslint-disable-next-line max-len\n    throw new Error(\n      `The \"${funcName}\" function requires a \"Request\" object as an argument. See https://commercetools.github.io/nodejs/sdk/Glossary.html#clientrequest`\n    )\n\n  if (typeof request.uri !== 'string')\n    // eslint-disable-next-line max-len\n    throw new Error(\n      `The \"${funcName}\" Request object requires a valid uri. See https://commercetools.github.io/nodejs/sdk/Glossary.html#clientrequest`\n    )\n\n  if (!options.allowedMethods.includes(request.method))\n    // eslint-disable-next-line max-len\n    throw new Error(\n      `The \"${funcName}\" Request object requires a valid method. See https://commercetools.github.io/nodejs/sdk/Glossary.html#clientrequest`\n    )\n}\n","/* @flow */\nimport qs from 'querystring'\nimport type {\n  Client,\n  ClientOptions,\n  ClientRequest,\n  ClientResult,\n  MiddlewareRequest,\n  MiddlewareResponse,\n  ProcessFn,\n  ProcessOptions,\n  SuccessResult,\n} from 'types/sdk'\nimport validate from './validate'\n\nfunction compose(...funcs: Array<Function>): Function {\n  // eslint-disable-next-line no-param-reassign\n  funcs = funcs.filter((func: Function): boolean => typeof func === 'function')\n\n  if (funcs.length === 1) return funcs[0]\n\n  return funcs.reduce(\n    (a: Function, b: Function): Function => (\n      ...args: Array<Function>\n    ): Array<Function> => a(b(...args))\n  )\n}\n\nexport default function createClient(options: ClientOptions): Client {\n  if (!options) throw new Error('Missing required options')\n\n  if (options.middlewares && !Array.isArray(options.middlewares))\n    throw new Error('Middlewares should be an array')\n\n  if (\n    !options.middlewares ||\n    !Array.isArray(options.middlewares) ||\n    !options.middlewares.length\n  )\n    throw new Error('You need to provide at least one middleware')\n\n  return {\n    /*\n      Given a request object,\n    */\n    execute(request: ClientRequest): Promise<ClientResult> {\n      validate('exec', request)\n\n      return new Promise((resolve: Function, reject: Function) => {\n        const resolver = (rq: MiddlewareRequest, rs: MiddlewareResponse) => {\n          // Note: pick the promise `resolve` and `reject` function from\n          // the response object. This is not necessary the same function\n          // given from the `new Promise` constructor, as middlewares could\n          // override those functions for custom behaviours.\n          if (rs.error) rs.reject(rs.error)\n          else {\n            const resObj: Object = {\n              body: rs.body || {},\n              statusCode: rs.statusCode,\n            }\n            if (rs.headers) resObj.headers = rs.headers\n            if (rs.request) resObj.request = rs.request\n            rs.resolve(resObj)\n          }\n        }\n\n        const dispatch = compose(...options.middlewares)(resolver)\n        dispatch(\n          request,\n          // Initial response shape\n          {\n            resolve,\n            reject,\n            body: undefined,\n            error: undefined,\n          }\n        )\n      })\n    },\n\n    process(\n      request: ClientRequest,\n      fn: ProcessFn,\n      processOpt: ProcessOptions\n    ): Promise<Array<Object>> {\n      validate('process', request, { allowedMethods: ['GET'] })\n\n      if (typeof fn !== 'function')\n        // eslint-disable-next-line max-len\n        throw new Error(\n          'The \"process\" function accepts a \"Function\" as a second argument that returns a Promise. See https://commercetools.github.io/nodejs/sdk/api/sdkClient.html#processrequest-processfn-options'\n        )\n\n      // Set default process options\n      const opt = {\n        total: Number.POSITIVE_INFINITY,\n        accumulate: true,\n        ...processOpt,\n      }\n      return new Promise((resolve: Function, reject: Function) => {\n        const [path, queryString] = request.uri.split('?')\n        const requestQuery = { ...qs.parse(queryString) }\n        const query = {\n          // defaults\n          limit: 20,\n          // merge given query params\n          ...requestQuery,\n        }\n\n        let hasFirstPageBeenProcessed = false\n        let itemsToGet = opt.total\n        const processPage = (lastId?: string, acc?: Array<any> = []) => {\n          // Use the lesser value between limit and itemsToGet in query\n          const limit = query.limit < itemsToGet ? query.limit : itemsToGet\n          const originalQueryString = qs.stringify({ ...query, limit })\n\n          const enhancedQuery = {\n            sort: 'id asc',\n            withTotal: false,\n            ...(lastId ? { where: `id > \"${lastId}\"` } : {}),\n          }\n          const enhancedQueryString = qs.stringify(enhancedQuery)\n          const enhancedRequest = {\n            ...request,\n            uri: `${path}?${enhancedQueryString}&${originalQueryString}`,\n          }\n\n          this.execute(enhancedRequest)\n            .then((payload: SuccessResult) => {\n              const { results, count: resultsLength } = payload.body\n\n              if (!resultsLength && hasFirstPageBeenProcessed) {\n                resolve(acc || [])\n                return\n              }\n\n              Promise.resolve(fn(payload))\n                .then((result: any) => {\n                  hasFirstPageBeenProcessed = true\n                  let accumulated\n                  if (opt.accumulate) accumulated = acc.concat(result || [])\n\n                  itemsToGet -= resultsLength\n                  // If there are no more items to get, it means the total number\n                  // of items in the original request have been fetched so we\n                  // resolve the promise.\n                  // Also, if we get less results in a page then the limit set it\n                  // means that there are no more pages and that we can finally\n                  // resolve the promise.\n                  if (resultsLength < query.limit || !itemsToGet) {\n                    resolve(accumulated || [])\n                    return\n                  }\n\n                  const last = results[resultsLength - 1]\n                  const newLastId = last && last.id\n                  processPage(newLastId, accumulated)\n                })\n                .catch(reject)\n            })\n            .catch(reject)\n        }\n\n        // Start iterating through pages\n        processPage()\n      })\n    },\n  }\n}\n","// eslint-disable-next-line import/prefer-default-export\nexport { default as createClient } from './client'\n"],"names":["validate","funcName","request","options","allowedMethods","METHODS","Error","uri","includes","method","compose","funcs","filter","func","length","reduce","a","b","createClient","middlewares","Array","isArray","execute","Promise","resolve","reject","resolver","rq","rs","error","resObj","body","statusCode","headers","dispatch","undefined","process","fn","processOpt","opt","total","Number","POSITIVE_INFINITY","accumulate","split","path","queryString","requestQuery","qs","parse","query","limit","hasFirstPageBeenProcessed","itemsToGet","processPage","lastId","acc","originalQueryString","stringify","enhancedQuery","sort","withTotal","where","enhancedQueryString","enhancedRequest","then","payload","results","resultsLength","count","result","accumulated","concat","last","newLastId","id","catch"],"mappings":"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"}