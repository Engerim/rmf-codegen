{"version":3,"file":"commercetools-sdk-client.cjs.js","sources":["../src/allowed-methods.js","../src/validate.js","../src/client.js","../src/index.js"],"sourcesContent":["export default [\n  'ACL',\n  'BIND',\n  'CHECKOUT',\n  'CONNECT',\n  'COPY',\n  'DELETE',\n  'GET',\n  'HEAD',\n  'LINK',\n  'LOCK',\n  'M-SEARCH',\n  'MERGE',\n  'MKACTIVITY',\n  'MKCALENDAR',\n  'MKCOL',\n  'MOVE',\n  'NOTIFY',\n  'OPTIONS',\n  'PATCH',\n  'POST',\n  'PROPFIND',\n  'PROPPATCH',\n  'PURGE',\n  'PUT',\n  'REBIND',\n  'REPORT',\n  'SEARCH',\n  'SOURCE',\n  'SUBSCRIBE',\n  'TRACE',\n  'UNBIND',\n  'UNLINK',\n  'UNLOCK',\n  'UNSUBSCRIBE',\n]\n","import METHODS from './allowed-methods'\n\nexport default function validate(\n  funcName: string,\n  request: Object,\n  options: Object = { allowedMethods: METHODS }\n) {\n  if (!request)\n    // eslint-disable-next-line max-len\n    throw new Error(\n      `The \"${funcName}\" function requires a \"Request\" object as an argument. See https://commercetools.github.io/nodejs/sdk/Glossary.html#clientrequest`\n    )\n\n  if (typeof request.uri !== 'string')\n    // eslint-disable-next-line max-len\n    throw new Error(\n      `The \"${funcName}\" Request object requires a valid uri. See https://commercetools.github.io/nodejs/sdk/Glossary.html#clientrequest`\n    )\n\n  if (!options.allowedMethods.includes(request.method))\n    // eslint-disable-next-line max-len\n    throw new Error(\n      `The \"${funcName}\" Request object requires a valid method. See https://commercetools.github.io/nodejs/sdk/Glossary.html#clientrequest`\n    )\n}\n","/* @flow */\nimport qs from 'querystring'\nimport type {\n  Client,\n  ClientOptions,\n  ClientRequest,\n  ClientResult,\n  MiddlewareRequest,\n  MiddlewareResponse,\n  ProcessFn,\n  ProcessOptions,\n  SuccessResult,\n} from 'types/sdk'\nimport validate from './validate'\n\nfunction compose(...funcs: Array<Function>): Function {\n  // eslint-disable-next-line no-param-reassign\n  funcs = funcs.filter((func: Function): boolean => typeof func === 'function')\n\n  if (funcs.length === 1) return funcs[0]\n\n  return funcs.reduce(\n    (a: Function, b: Function): Function => (\n      ...args: Array<Function>\n    ): Array<Function> => a(b(...args))\n  )\n}\n\nexport default function createClient(options: ClientOptions): Client {\n  if (!options) throw new Error('Missing required options')\n\n  if (options.middlewares && !Array.isArray(options.middlewares))\n    throw new Error('Middlewares should be an array')\n\n  if (\n    !options.middlewares ||\n    !Array.isArray(options.middlewares) ||\n    !options.middlewares.length\n  )\n    throw new Error('You need to provide at least one middleware')\n\n  return {\n    /*\n      Given a request object,\n    */\n    execute(request: ClientRequest): Promise<ClientResult> {\n      validate('exec', request)\n\n      return new Promise((resolve: Function, reject: Function) => {\n        const resolver = (rq: MiddlewareRequest, rs: MiddlewareResponse) => {\n          // Note: pick the promise `resolve` and `reject` function from\n          // the response object. This is not necessary the same function\n          // given from the `new Promise` constructor, as middlewares could\n          // override those functions for custom behaviours.\n          if (rs.error) rs.reject(rs.error)\n          else {\n            const resObj: Object = {\n              body: rs.body || {},\n              statusCode: rs.statusCode,\n            }\n            if (rs.headers) resObj.headers = rs.headers\n            if (rs.request) resObj.request = rs.request\n            rs.resolve(resObj)\n          }\n        }\n\n        const dispatch = compose(...options.middlewares)(resolver)\n        dispatch(\n          request,\n          // Initial response shape\n          {\n            resolve,\n            reject,\n            body: undefined,\n            error: undefined,\n          }\n        )\n      })\n    },\n\n    process(\n      request: ClientRequest,\n      fn: ProcessFn,\n      processOpt: ProcessOptions\n    ): Promise<Array<Object>> {\n      validate('process', request, { allowedMethods: ['GET'] })\n\n      if (typeof fn !== 'function')\n        // eslint-disable-next-line max-len\n        throw new Error(\n          'The \"process\" function accepts a \"Function\" as a second argument that returns a Promise. See https://commercetools.github.io/nodejs/sdk/api/sdkClient.html#processrequest-processfn-options'\n        )\n\n      // Set default process options\n      const opt = {\n        total: Number.POSITIVE_INFINITY,\n        accumulate: true,\n        ...processOpt,\n      }\n      return new Promise((resolve: Function, reject: Function) => {\n        const [path, queryString] = request.uri.split('?')\n        const requestQuery = { ...qs.parse(queryString) }\n        const query = {\n          // defaults\n          limit: 20,\n          // merge given query params\n          ...requestQuery,\n        }\n\n        let hasFirstPageBeenProcessed = false\n        let itemsToGet = opt.total\n        const processPage = (lastId?: string, acc?: Array<any> = []) => {\n          // Use the lesser value between limit and itemsToGet in query\n          const limit = query.limit < itemsToGet ? query.limit : itemsToGet\n          const originalQueryString = qs.stringify({ ...query, limit })\n\n          const enhancedQuery = {\n            sort: 'id asc',\n            withTotal: false,\n            ...(lastId ? { where: `id > \"${lastId}\"` } : {}),\n          }\n          const enhancedQueryString = qs.stringify(enhancedQuery)\n          const enhancedRequest = {\n            ...request,\n            uri: `${path}?${enhancedQueryString}&${originalQueryString}`,\n          }\n\n          this.execute(enhancedRequest)\n            .then((payload: SuccessResult) => {\n              const { results, count: resultsLength } = payload.body\n\n              if (!resultsLength && hasFirstPageBeenProcessed) {\n                resolve(acc || [])\n                return\n              }\n\n              Promise.resolve(fn(payload))\n                .then((result: any) => {\n                  hasFirstPageBeenProcessed = true\n                  let accumulated\n                  if (opt.accumulate) accumulated = acc.concat(result || [])\n\n                  itemsToGet -= resultsLength\n                  // If there are no more items to get, it means the total number\n                  // of items in the original request have been fetched so we\n                  // resolve the promise.\n                  // Also, if we get less results in a page then the limit set it\n                  // means that there are no more pages and that we can finally\n                  // resolve the promise.\n                  if (resultsLength < query.limit || !itemsToGet) {\n                    resolve(accumulated || [])\n                    return\n                  }\n\n                  const last = results[resultsLength - 1]\n                  const newLastId = last && last.id\n                  processPage(newLastId, accumulated)\n                })\n                .catch(reject)\n            })\n            .catch(reject)\n        }\n\n        // Start iterating through pages\n        processPage()\n      })\n    },\n  }\n}\n","// eslint-disable-next-line import/prefer-default-export\nexport { default as createClient } from './client'\n"],"names":["validate","funcName","request","options","allowedMethods","METHODS","Error","uri","includes","method","compose","funcs","filter","func","length","reduce","a","b","createClient","middlewares","Array","isArray","execute","Promise","resolve","reject","resolver","rq","rs","error","resObj","body","statusCode","headers","dispatch","undefined","process","fn","processOpt","opt","total","Number","POSITIVE_INFINITY","accumulate","split","path","queryString","requestQuery","qs","parse","query","limit","hasFirstPageBeenProcessed","itemsToGet","processPage","lastId","acc","originalQueryString","stringify","enhancedQuery","sort","withTotal","where","enhancedQueryString","enhancedRequest","then","payload","results","resultsLength","count","result","accumulated","concat","last","newLastId","id","catch"],"mappings":"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"}