{"version":3,"file":"commercetools-sdk-middleware-http.cjs.js","sources":["../src/errors.js","../src/parse-headers.js","../src/http.js"],"sourcesContent":["function defineError(statusCode, message, meta = {}) {\n  // eslint-disable-next-line no-multi-assign\n  this.status = this.statusCode = this.code = statusCode\n  this.message = message\n  Object.assign(this, meta)\n\n  this.name = this.constructor.name\n  // eslint-disable-next-line no-proto\n  this.constructor.prototype.__proto__ = Error.prototype\n\n  if (Error.captureStackTrace) Error.captureStackTrace(this, this.constructor)\n}\n\n/* eslint-disable max-len, flowtype/require-parameter-type */\nexport function NetworkError(...args) {\n  defineError.call(\n    this,\n    0 /* special code to indicate network errors */,\n    ...args\n  )\n}\nexport function HttpError(...args) {\n  defineError.call(this, /* code will be passed as arg */ ...args)\n}\nexport function BadRequest(...args) {\n  defineError.call(this, 400, ...args)\n}\nexport function Unauthorized(...args) {\n  defineError.call(this, 401, ...args)\n}\nexport function Forbidden(...args) {\n  defineError.call(this, 403, ...args)\n}\nexport function NotFound(...args) {\n  defineError.call(this, 404, ...args)\n}\nexport function ConcurrentModification(...args) {\n  defineError.call(this, 409, ...args)\n}\nexport function InternalServerError(...args) {\n  defineError.call(this, 500, ...args)\n}\nexport function ServiceUnavailable(...args) {\n  defineError.call(this, 503, ...args)\n}\n/* eslint-enable max-len */\n\nexport default function getErrorByCode(code) {\n  switch (code) {\n    case 0:\n      return NetworkError\n    case 400:\n      return BadRequest\n    case 401:\n      return Unauthorized\n    case 403:\n      return Forbidden\n    case 404:\n      return NotFound\n    case 409:\n      return ConcurrentModification\n    case 500:\n      return InternalServerError\n    case 503:\n      return ServiceUnavailable\n    default:\n      return undefined\n  }\n}\n","export default function parseHeaders(headers) {\n  if (headers.raw)\n    // node-fetch\n    return headers.raw()\n\n  // Tmp fix for Firefox until it supports iterables\n  if (!headers.forEach) return {}\n\n  // whatwg-fetch\n  const map = {}\n  headers.forEach((value, name) => {\n    map[name] = value\n  })\n  return map\n}\n","/* @flow */\n\nimport type {\n  HttpErrorType,\n  HttpMiddlewareOptions,\n  Middleware,\n  MiddlewareRequest,\n  MiddlewareResponse,\n  Next,\n} from 'types/sdk'\n\nimport getErrorByCode, { NetworkError, HttpError } from './errors'\nimport parseHeaders from './parse-headers'\n\nfunction createError({ statusCode, message, ...rest }: Object): HttpErrorType {\n  let errorMessage = message || 'Unexpected non-JSON error response'\n  if (statusCode === 404)\n    errorMessage = `URI not found: ${rest.originalRequest.uri}`\n\n  const ResponseError = getErrorByCode(statusCode)\n  if (ResponseError) return new ResponseError(errorMessage, rest)\n  return new HttpError(statusCode, errorMessage, rest)\n}\n\n// calculates the delay duration exponentially\n// More info about the algorithm use here https://goo.gl/Xk8h5f\nfunction calcDelayDuration(\n  retryCount: number,\n  retryDelay: number,\n  maxRetries: number,\n  backoff: boolean,\n  maxDelay: number\n): number {\n  if (backoff)\n    return retryCount !== 0 // do not increase if it's the first retry\n      ? Math.min(\n          Math.round((Math.random() + 1) * retryDelay * 2 ** retryCount),\n          maxDelay\n        )\n      : retryDelay\n  return retryDelay\n}\n\nfunction maskAuthData(request: Object, maskSensitiveHeaderData: ?boolean) {\n  if (maskSensitiveHeaderData) {\n    if (request.headers.authorization)\n      request.headers.authorization = ['Bearer ********']\n    if (request.headers.Authorization)\n      request.headers.Authorization = ['Bearer ********']\n  }\n}\n\nexport default function createHttpMiddleware({\n  host,\n  credentialsMode,\n  includeResponseHeaders,\n  includeOriginalRequest,\n  maskSensitiveHeaderData = true,\n  enableRetry,\n  retryConfig: {\n    // encourage exponential backoff to prevent spamming the server if down\n    maxRetries = 10,\n    backoff = true,\n    retryDelay = 200,\n    maxDelay = Infinity,\n  } = {},\n  fetch: fetcher,\n}: HttpMiddlewareOptions): Middleware {\n  if (!fetcher && typeof fetch === 'undefined')\n    throw new Error(\n      '`fetch` is not available. Please pass in `fetch` as an option or have it globally available.'\n    )\n\n  if (!fetcher)\n    // `fetcher` is set here rather than the destructuring to ensure fetch is\n    // declared before referencing it otherwise it would cause a `ReferenceError`.\n    // For reference of this pattern: https://github.com/apollographql/apollo-link/blob/498b413a5b5199b0758ce898b3bb55451f57a2fa/packages/apollo-link-http/src/httpLink.ts#L49\n\n    // eslint-disable-next-line\n    fetcher = fetch\n\n  return (next: Next): Next => (\n    request: MiddlewareRequest,\n    response: MiddlewareResponse\n  ) => {\n    const url = host.replace(/\\/$/, '') + request.uri\n    const body =\n      typeof request.body === 'string' || Buffer.isBuffer(request.body)\n        ? request.body\n        : // NOTE: `stringify` of `null` gives the String('null')\n          JSON.stringify(request.body || undefined)\n    const requestHeader = {\n      'Content-Type': ['application/json'],\n      ...request.headers,\n      ...(body\n        ? { 'Content-Length': Buffer.byteLength(body).toString() }\n        : null),\n    }\n    const fetchOptions: Object = {\n      method: request.method,\n      headers: requestHeader,\n      ...(credentialsMode ? { credentials: credentialsMode } : {}),\n      ...(body ? { body } : null),\n    }\n    let retryCount = 0\n    // wrap in a fn so we can retry if error occur\n    function executeFetch() {\n      // $FlowFixMe\n      fetcher(url, fetchOptions).then(\n        (res: Response) => {\n          if (res.ok) {\n            if (fetchOptions.method === 'HEAD') {\n              next(request, {\n                ...response,\n                statusCode: res.status,\n              })\n              return\n            }\n\n            res.json().then((result: Object) => {\n              const parsedResponse: Object = {\n                ...response,\n                body: result,\n                statusCode: res.status,\n              }\n\n              if (includeResponseHeaders)\n                parsedResponse.headers = parseHeaders(res.headers)\n\n              if (includeOriginalRequest) {\n                parsedResponse.request = {\n                  ...fetchOptions,\n                }\n                maskAuthData(parsedResponse.request, maskSensitiveHeaderData)\n              }\n              next(request, parsedResponse)\n            })\n            return\n          }\n          if (res.status === 503 && enableRetry)\n            if (retryCount < maxRetries) {\n              setTimeout(\n                executeFetch,\n                calcDelayDuration(\n                  retryCount,\n                  retryDelay,\n                  maxRetries,\n                  backoff,\n                  maxDelay\n                )\n              )\n              retryCount += 1\n              return\n            }\n\n          // Server responded with an error. Try to parse it as JSON, then\n          // return a proper error type with all necessary meta information.\n          res.text().then((text: any) => {\n            // Try to parse the error response as JSON\n            let parsed\n            try {\n              parsed = JSON.parse(text)\n            } catch (error) {\n              parsed = text\n            }\n\n            const error: HttpErrorType = createError({\n              statusCode: res.status,\n              originalRequest: request,\n              retryCount,\n              headers: parseHeaders(res.headers),\n              ...(typeof parsed === 'object'\n                ? { message: parsed.message, body: parsed }\n                : { message: parsed, body: parsed }),\n            })\n            maskAuthData(error.originalRequest, maskSensitiveHeaderData)\n            // Let the final resolver to reject the promise\n            const parsedResponse = {\n              ...response,\n              error,\n              statusCode: res.status,\n            }\n            next(request, parsedResponse)\n          })\n        },\n        // We know that this is a \"network\" error thrown by the `fetch` library\n        (e: Error) => {\n          if (enableRetry)\n            if (retryCount < maxRetries) {\n              setTimeout(\n                executeFetch,\n                calcDelayDuration(\n                  retryCount,\n                  retryDelay,\n                  maxRetries,\n                  backoff,\n                  maxDelay\n                )\n              )\n              retryCount += 1\n              return\n            }\n\n          const error = new NetworkError(e.message, {\n            originalRequest: request,\n            retryCount,\n          })\n          maskAuthData(error.originalRequest, maskSensitiveHeaderData)\n          next(request, { ...response, error, statusCode: 0 })\n        }\n      )\n    }\n    executeFetch()\n  }\n}\n"],"names":["defineError","statusCode","message","meta","status","code","Object","assign","name","constructor","prototype","__proto__","Error","captureStackTrace","NetworkError","args","call","HttpError","BadRequest","Unauthorized","Forbidden","NotFound","ConcurrentModification","InternalServerError","ServiceUnavailable","getErrorByCode","undefined","parseHeaders","headers","raw","forEach","map","value","createError","rest","errorMessage","originalRequest","uri","ResponseError","calcDelayDuration","retryCount","retryDelay","maxRetries","backoff","maxDelay","Math","min","round","random","maskAuthData","request","maskSensitiveHeaderData","authorization","Authorization","createHttpMiddleware","host","credentialsMode","includeResponseHeaders","includeOriginalRequest","enableRetry","retryConfig","Infinity","fetcher","fetch","next","response","url","replace","body","Buffer","isBuffer","JSON","stringify","requestHeader","byteLength","toString","fetchOptions","method","credentials","executeFetch","then","res","ok","json","result","parsedResponse","setTimeout","text","parsed","parse","error","e"],"mappings":"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"}