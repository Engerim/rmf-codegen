{"version":3,"file":"commercetools-sdk-middleware-queue.es.js","sources":["../src/queue.js","../src/index.js"],"sourcesContent":["/* @flow */\nimport type {\n  QueueMiddlewareOptions,\n  Dispatch,\n  Middleware,\n  MiddlewareRequest,\n  MiddlewareResponse,\n  Next,\n} from 'types/sdk'\n\ntype Task = {\n  request: MiddlewareRequest,\n  response: MiddlewareResponse,\n}\n\nexport default function createQueueMiddleware({\n  concurrency = 20,\n}: QueueMiddlewareOptions = {}): Middleware {\n  const queue: Array<Task> = []\n  let runningCount = 0\n\n  const dequeue = (next: Dispatch) => {\n    // We assume here that this task has been completed\n    runningCount -= 1\n\n    // Check if there are any other pending tasks and execute them\n    if (queue.length && runningCount <= concurrency) {\n      const nextTask = queue.shift()\n      runningCount += 1\n      next(nextTask.request, nextTask.response)\n    }\n  }\n\n  return (next: Next): Next => (\n    request: MiddlewareRequest,\n    response: MiddlewareResponse\n  ) => {\n    // Override response `resolve` and `reject` to know when the request has\n    // been completed and therefore trigger a pending task in the queue.\n    const patchedResponse = {\n      ...response,\n      resolve(data: any) {\n        // Resolve original promise\n        response.resolve(data)\n        dequeue(next)\n      },\n      reject(error: any) {\n        // Reject original promise\n        response.reject(error)\n        dequeue(next)\n      },\n    }\n\n    // Add task to the queue\n    queue.push({ request, response: patchedResponse })\n\n    // If possible, run the task straight away\n    if (runningCount < concurrency) {\n      const nextTask = queue.shift()\n      runningCount += 1\n\n      next(nextTask.request, nextTask.response)\n    }\n  }\n}\n","// eslint-disable-next-line import/prefer-default-export\nexport { default as createQueueMiddleware } from './queue'\n"],"names":["createQueueMiddleware","concurrency","queue","runningCount","dequeue","next","length","nextTask","shift","request","response","patchedResponse","resolve","data","reject","error","push"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAee,SAASA,qBAAT,GAE6B;iFAAhB,EAAgB;8BAD1CC,WAC0C;MAD1CA,WAC0C,iCAD5B,EAC4B;;MACpCC,KAAkB,GAAG,EAA3B;MACIC,YAAY,GAAG,CAAnB;;MAEMC,OAAO,GAAG,SAAVA,OAAU,CAACC,IAAD,EAAoB;;IAElCF,YAAY,IAAI,CAAhB,CAFkC;;QAK9BD,KAAK,CAACI,MAAN,IAAgBH,YAAY,IAAIF,WAApC,EAAiD;UACzCM,QAAQ,GAAGL,KAAK,CAACM,KAAN,EAAjB;MACAL,YAAY,IAAI,CAAhB;MACAE,IAAI,CAACE,QAAQ,CAACE,OAAV,EAAmBF,QAAQ,CAACG,QAA5B,CAAJ;;GARJ;;SAYO,UAACL,IAAD;WAAsB,UAC3BI,OAD2B,EAE3BC,QAF2B,EAGxB;;;UAGGC,eAAe,qBAChBD,QADgB;QAEnBE,OAFmB,mBAEXC,IAFW,EAEA;;UAEjBH,QAAQ,CAACE,OAAT,CAAiBC,IAAjB;UACAT,OAAO,CAACC,IAAD,CAAP;SALiB;QAOnBS,MAPmB,kBAOZC,KAPY,EAOA;;UAEjBL,QAAQ,CAACI,MAAT,CAAgBC,KAAhB;UACAX,OAAO,CAACC,IAAD,CAAP;;QAVJ,CAHG;;;MAkBHH,KAAK,CAACc,IAAN,CAAW;QAAEP,OAAO,EAAPA,OAAF;QAAWC,QAAQ,EAAEC;OAAhC,EAlBG;;UAqBCR,YAAY,GAAGF,WAAnB,EAAgC;YACxBM,QAAQ,GAAGL,KAAK,CAACM,KAAN,EAAjB;QACAL,YAAY,IAAI,CAAhB;QAEAE,IAAI,CAACE,QAAQ,CAACE,OAAV,EAAmBF,QAAQ,CAACG,QAA5B,CAAJ;;KA5BG;GAAP;;;ACjCF;;;;"}