{"version":3,"file":"commercetools-sdk-middleware-queue.umd.min.js","sources":["../src/queue.js"],"sourcesContent":["/* @flow */\nimport type {\n  QueueMiddlewareOptions,\n  Dispatch,\n  Middleware,\n  MiddlewareRequest,\n  MiddlewareResponse,\n  Next,\n} from 'types/sdk'\n\ntype Task = {\n  request: MiddlewareRequest,\n  response: MiddlewareResponse,\n}\n\nexport default function createQueueMiddleware({\n  concurrency = 20,\n}: QueueMiddlewareOptions = {}): Middleware {\n  const queue: Array<Task> = []\n  let runningCount = 0\n\n  const dequeue = (next: Dispatch) => {\n    // We assume here that this task has been completed\n    runningCount -= 1\n\n    // Check if there are any other pending tasks and execute them\n    if (queue.length && runningCount <= concurrency) {\n      const nextTask = queue.shift()\n      runningCount += 1\n      next(nextTask.request, nextTask.response)\n    }\n  }\n\n  return (next: Next): Next => (\n    request: MiddlewareRequest,\n    response: MiddlewareResponse\n  ) => {\n    // Override response `resolve` and `reject` to know when the request has\n    // been completed and therefore trigger a pending task in the queue.\n    const patchedResponse = {\n      ...response,\n      resolve(data: any) {\n        // Resolve original promise\n        response.resolve(data)\n        dequeue(next)\n      },\n      reject(error: any) {\n        // Reject original promise\n        response.reject(error)\n        dequeue(next)\n      },\n    }\n\n    // Add task to the queue\n    queue.push({ request, response: patchedResponse })\n\n    // If possible, run the task straight away\n    if (runningCount < concurrency) {\n      const nextTask = queue.shift()\n      runningCount += 1\n\n      next(nextTask.request, nextTask.response)\n    }\n  }\n}\n"],"names":["concurrency","queue","runningCount","dequeue","next","length","nextTask","shift","request","response","patchedResponse","resolve","data","reject","error","push"],"mappings":"oPAee,yEAEa,IAD1BA,YAAAA,aAAc,KAERC,EAAqB,GACvBC,EAAe,EAEbC,EAAU,SAACC,MAEfF,GAAgB,EAGZD,EAAMI,QAAUH,GAAgBF,EAAa,KACzCM,EAAWL,EAAMM,QACvBL,GAAgB,EAChBE,EAAKE,EAASE,QAASF,EAASG,mBAI7B,SAACL,UAAqB,SAC3BI,EACAC,OAIMC,gbACDD,GACHE,iBAAQC,GAENH,EAASE,QAAQC,GACjBT,EAAQC,IAEVS,gBAAOC,GAELL,EAASI,OAAOC,GAChBX,EAAQC,SAKZH,EAAMc,KAAK,CAAEP,QAAAA,EAASC,SAAUC,IAG5BR,EAAeF,EAAa,KACxBM,EAAWL,EAAMM,QACvBL,GAAgB,EAEhBE,EAAKE,EAASE,QAASF,EAASG"}