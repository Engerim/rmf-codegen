{"version":3,"file":"commercetools-sdk-middleware-queue.umd.js","sources":["../src/queue.js","../src/index.js"],"sourcesContent":["/* @flow */\nimport type {\n  QueueMiddlewareOptions,\n  Dispatch,\n  Middleware,\n  MiddlewareRequest,\n  MiddlewareResponse,\n  Next,\n} from 'types/sdk'\n\ntype Task = {\n  request: MiddlewareRequest,\n  response: MiddlewareResponse,\n}\n\nexport default function createQueueMiddleware({\n  concurrency = 20,\n}: QueueMiddlewareOptions = {}): Middleware {\n  const queue: Array<Task> = []\n  let runningCount = 0\n\n  const dequeue = (next: Dispatch) => {\n    // We assume here that this task has been completed\n    runningCount -= 1\n\n    // Check if there are any other pending tasks and execute them\n    if (queue.length && runningCount <= concurrency) {\n      const nextTask = queue.shift()\n      runningCount += 1\n      next(nextTask.request, nextTask.response)\n    }\n  }\n\n  return (next: Next): Next => (\n    request: MiddlewareRequest,\n    response: MiddlewareResponse\n  ) => {\n    // Override response `resolve` and `reject` to know when the request has\n    // been completed and therefore trigger a pending task in the queue.\n    const patchedResponse = {\n      ...response,\n      resolve(data: any) {\n        // Resolve original promise\n        response.resolve(data)\n        dequeue(next)\n      },\n      reject(error: any) {\n        // Reject original promise\n        response.reject(error)\n        dequeue(next)\n      },\n    }\n\n    // Add task to the queue\n    queue.push({ request, response: patchedResponse })\n\n    // If possible, run the task straight away\n    if (runningCount < concurrency) {\n      const nextTask = queue.shift()\n      runningCount += 1\n\n      next(nextTask.request, nextTask.response)\n    }\n  }\n}\n","// eslint-disable-next-line import/prefer-default-export\nexport { default as createQueueMiddleware } from './queue'\n"],"names":["createQueueMiddleware","concurrency","queue","runningCount","dequeue","next","length","nextTask","shift","request","response","patchedResponse","resolve","data","reject","error","push"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAee,SAASA,qBAAT,GAE6B;EAAA,iFAAhB,EAAgB;EAAA,8BAD1CC,WAC0C;EAAA,MAD1CA,WAC0C,iCAD5B,EAC4B;;EAC1C,MAAMC,KAAkB,GAAG,EAA3B;EACA,MAAIC,YAAY,GAAG,CAAnB;;EAEA,MAAMC,OAAO,GAAG,SAAVA,OAAU,CAACC,IAAD,EAAoB;EAClC;EACAF,IAAAA,YAAY,IAAI,CAAhB,CAFkC;;EAKlC,QAAID,KAAK,CAACI,MAAN,IAAgBH,YAAY,IAAIF,WAApC,EAAiD;EAC/C,UAAMM,QAAQ,GAAGL,KAAK,CAACM,KAAN,EAAjB;EACAL,MAAAA,YAAY,IAAI,CAAhB;EACAE,MAAAA,IAAI,CAACE,QAAQ,CAACE,OAAV,EAAmBF,QAAQ,CAACG,QAA5B,CAAJ;EACD;EACF,GAVD;;EAYA,SAAO,UAACL,IAAD;EAAA,WAAsB,UAC3BI,OAD2B,EAE3BC,QAF2B,EAGxB;EACH;EACA;EACA,UAAMC,eAAe,qBAChBD,QADgB;EAEnBE,QAAAA,OAFmB,mBAEXC,IAFW,EAEA;EACjB;EACAH,UAAAA,QAAQ,CAACE,OAAT,CAAiBC,IAAjB;EACAT,UAAAA,OAAO,CAACC,IAAD,CAAP;EACD,SANkB;EAOnBS,QAAAA,MAPmB,kBAOZC,KAPY,EAOA;EACjB;EACAL,UAAAA,QAAQ,CAACI,MAAT,CAAgBC,KAAhB;EACAX,UAAAA,OAAO,CAACC,IAAD,CAAP;EACD;EAXkB,QAArB,CAHG;;;EAkBHH,MAAAA,KAAK,CAACc,IAAN,CAAW;EAAEP,QAAAA,OAAO,EAAPA,OAAF;EAAWC,QAAAA,QAAQ,EAAEC;EAArB,OAAX,EAlBG;;EAqBH,UAAIR,YAAY,GAAGF,WAAnB,EAAgC;EAC9B,YAAMM,QAAQ,GAAGL,KAAK,CAACM,KAAN,EAAjB;EACAL,QAAAA,YAAY,IAAI,CAAhB;EAEAE,QAAAA,IAAI,CAACE,QAAQ,CAACE,OAAV,EAAmBF,QAAQ,CAACG,QAA5B,CAAJ;EACD;EACF,KA9BM;EAAA,GAAP;EA+BD;;EChED;;;;;;;;;;;;"}